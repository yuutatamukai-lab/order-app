<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <title>マイナス処理</title>
    <meta name="viewport" content="width=device, initial-scale=1.0" />

    <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      margin: 16px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 12px;
    }

    .info {
      font-size: 16px;
      margin-bottom: 16px;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 12px;
      font-size: 18px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    input[type="number"] {
      font-size: 20px;
      width: 100px;
      padding: 6px;
    }

    button {
      font-size: 18px;
      padding: 10px 16px;
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    dialog {
      border: 1px solid #ccc;
      padding: 16px;
      font-size: 18px;
    }

    /* 数字入力の標準スピンボタンを非表示 */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }

    /* 大きな + / - ボタン */
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .qty-controls button {
      font-size: 24px;
      width: 44px;
      height: 44px;
    }

    #dateButton {
      font-size: 20px;
      padding: 14px 20px;
    }

    /* 日付選択ダイアログを大きく・押しやすく */
    #dateDialog select {
      font-size: 26px;
      padding: 12px 16px;
    }

    #dateDialog button {
      font-size: 22px;
      padding: 12px 20px;
    }

    #dateDialog {
      min-width: 320px;
    }
  </style>
</head>
<body>

<h1>マイナス処理（数量調整）</h1>

<div style="margin-bottom:16px;">
  <label style="font-size:18px;">店舗：</label>
  <select id="storeSelect" style="font-size:18px;padding:8px;">
    <option value="store_a">仙石山</option>
    <option value="store_b">麹町</option>
    <option value="store_c">西麻布</option>
  </select>
</div>

<div class="info" id="currentInfo"></div>

<!-- 日付選択 -->
<div style="margin-bottom:16px;">
  <button id="dateButton">日付を選択</button>
  <span id="selectedDate"></span>
</div>

<dialog id="dateDialog">
  <div style="display:flex; gap:8px; margin-bottom:12px;">
    <select id="yearSelect"></select>
    <select id="monthSelect"></select>
    <select id="daySelect"></select>
  </div>
  <button id="dateOk">決定</button>
  <button id="dateCancel">キャンセル</button>
</dialog>

<div style="margin-bottom:16px;">
  <label style="font-size:18px;">カテゴリー：</label>
  <select id="categorySelect" style="font-size:18px;padding:8px;"></select>
</div>

<table>
  <thead>
    <tr>
      <th>品目</th>
      <th>マイナス数量</th>
    </tr>
  </thead>
  <tbody id="itemBody"></tbody>
</table>

<div class="actions">
  <button id="saveBtn">この内容でマイナス処理</button>
  <button onclick="location.href='index.html'">管理画面に戻る</button>
</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  console.log("adjust.js start");

  /* ===== 設定 ===== */
  let STORE_ID = "store_a"; // ← タブレットごとに変更
  const MACHINE_ID = "admin-adjust";

  const SUPABASE_URL = "https://ididxhgszvdvfyfzwfgm.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkaWR4aGdzenZkdmZ5Znp3ZmdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3Mzc5MzgsImV4cCI6MjA4MjMxMzkzOH0.ZVOS2nxT8KbCB7U5xL0DKy9DGj3KrjJU7AJkR0_b33g";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ===============================
     認証・権限チェック（Master / Adjust 専用）
  ================================ */

  // 初期セッションを正しく取得
  const {
    data: { session }
  } = await supabase.auth.getSession();

  if (!session || !session.user) {
    // 未ログインは強制的にログイン画面へ
    location.replace("../login.html");
    throw new Error("not authenticated");
  }

  const user = session.user;

  // Master 権限のみ許可
  if (user.user_metadata?.role !== "master") {
    location.replace("../login.html");
    throw new Error("not authorized");
  }

  // セッション切れ・ログアウト検知
  supabase.auth.onAuthStateChange((event) => {
    if (event === "SIGNED_OUT") {
      location.replace("../login.html");
    }
  });

  /* ===== 日付UI ===== */
  const today = new Date().toISOString().slice(0, 10);
  let selectedDate = today;

  const selectedDateSpan = document.getElementById("selectedDate");
  selectedDateSpan.textContent = selectedDate;

  const dateDialog = document.getElementById("dateDialog");
  const yearSelect = document.getElementById("yearSelect");
  const monthSelect = document.getElementById("monthSelect");
  const daySelect = document.getElementById("daySelect");

  const currentYear = new Date().getFullYear();
  for (let y = currentYear - 1; y <= currentYear + 1; y++) {
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y + "年";
    yearSelect.appendChild(opt);
  }

  for (let m = 1; m <= 12; m++) {
    const opt = document.createElement("option");
    opt.value = String(m).padStart(2, "0");
    opt.textContent = m + "月";
    monthSelect.appendChild(opt);
  }

  for (let d = 1; d <= 31; d++) {
    const opt = document.createElement("option");
    opt.value = String(d).padStart(2, "0");
    opt.textContent = d + "日";
    daySelect.appendChild(opt);
  }

  function setSelectFromDate(dateStr) {
    const [y, m, d] = dateStr.split("-");
    yearSelect.value = y;
    monthSelect.value = m;
    daySelect.value = d;
  }

  setSelectFromDate(selectedDate);

  document.getElementById("dateButton").addEventListener("click", () => {
    setSelectFromDate(selectedDate);
    dateDialog.showModal();
  });

  document.getElementById("dateOk").addEventListener("click", () => {
    selectedDate = `${yearSelect.value}-${monthSelect.value}-${daySelect.value}`;
    selectedDateSpan.textContent = selectedDate;
    updateInfo();
    dateDialog.close();
  });

  document.getElementById("dateCancel").addEventListener("click", () => {
    dateDialog.close();
  });

  /* ===== 情報表示 ===== */
  const storeSelect = document.getElementById("storeSelect");

  function updateInfo() {
    document.getElementById("currentInfo").textContent =
      `店舗：${STORE_ID} / 日付：${selectedDate}`;
  }

  updateInfo();

  storeSelect.addEventListener("change", () => {
    STORE_ID = storeSelect.value;
    updateInfo();
  });

 /* ===== 品目一覧（カテゴリー表示）===== */
  const ITEMS_BY_CATEGORY = {
    "Food": [
      "Lasagna",
      "vegitarian Lasagna",
      "Parmigiana",
      "pollo",
      "patate",
      "Pancetta",
      "Funghi",
      "Costine",
      "Carote",
      "Cotoletta",
      "Filetto",
      "Pure Patate",
      "SalsaVerdure",
      "Trippa",
        "Caponata",
      "Moscardini",
      "Pure Ceci",
      "Spaghetti",
      "Maccheroni",
      "Casareccie",
      "Fusilli",
      "Gramigna",
      "Bacon",
      "Prosciutto Curdo",
      "Prosciutto Cotto",
      "Porchetta",
      "Mozzarella",
      "Taralli",
      "Taruto(Egg set)"

      
    ],
    "Bakery,dolce": [
    "Bombolone Crema",
    "Bombolone Pisutacchio",
    "Bomboloncino",
    "Cannolo",
    "Ciamabella",
    "Frozen Cornetto",
    "Raspberry Brownie",
    "Short Cake",
    "Chocolate Cookie",
    "Carrot Cake Muffin",
    "Matcha Chocolate Muffin",
    "Tiramisu",
    "Tiramisu Pistacchio",
    "Budino",
    "Panna Cotta",
    "Cheese Cake",
    "Blueberry Cheese Cake"
    ],
    "Papping": [
      "Hot cap M",
      "Hot cap M Lid",
      "Hot cap L",
      "Hot cap L Lid",
      "Ice cap M",
      "Ice cap M Lid",
      "Ice cap L",
      "Ice cap L Lid",
      "Pudding Cup",
      "Pudding Cup Lid",
      "Coffee sugar",
      "Coffee sugar Large",
      "Coffee suger Brown",
      "PASCUCI seal",
      "Cutlery Pouch White",
      "PASCUCCI paper bag",
      "Lunch mat",
      "Coffee beans"
      
    ]
  };

  const tbody = document.getElementById("itemBody");

  const categorySelect = document.getElementById("categorySelect");

  Object.keys(ITEMS_BY_CATEGORY).forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });

  function renderItems(category) {
    tbody.innerHTML = "";

    ITEMS_BY_CATEGORY[category].forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item}</td>
        <td>
          <div class="qty-controls">
            <button type="button" data-minus>−</button>
            <input type="number" min="0" value="0" data-item="${item}">
            <button type="button" data-plus>＋</button>
          </div>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 初期表示
  renderItems(categorySelect.value);

  // 切り替え
  categorySelect.addEventListener("change", () => {
    renderItems(categorySelect.value);
  });

  tbody.addEventListener("click", (e) => {
    const btn = e.target;
    if (!btn.matches("[data-plus],[data-minus]")) return;

    const input = btn.parentElement.querySelector("input[type='number']");
    let value = Number(input.value) || 0;

    if (btn.hasAttribute("data-plus")) value++;
    if (btn.hasAttribute("data-minus") && value > 0) value--;

    input.value = value;
  });

/* ===== 保存処理 ===== */
  document.getElementById("saveBtn").addEventListener("click", async () => {
    const category = categorySelect.value;
    const inputs = document.querySelectorAll("input[data-item]");
    const rows = [];

    inputs.forEach(input => {
      const qty = Number(input.value);
      if (qty > 0) {
        rows.push({
          store_id: STORE_ID,
          machine_id: MACHINE_ID,
          category: category, 
          item: input.dataset.item,
          quantity: -qty,            // ← 必ずマイナス
          order_date: selectedDate
        });
      }
    });

    if (rows.length === 0) {
      alert("マイナス数量が入力されていません");
      return;
    }

    if (!confirm("この内容でマイナス処理を行いますか？")) {
      return;
    }

    const { error } = await supabase
      .from("orders")
      .insert(rows);

    if (error) {
      console.error(error);
      alert("保存に失敗しました");
      return;
    }

    alert("マイナス処理を保存しました");
    location.href = "index.html";
  });

  /* ===============================
     ログアウト（強制）
  ================================ */
  const logoutBtn = document.getElementById("logout");

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await supabase.auth.signOut();
      location.replace("../login.html");
    });
  }
</script>

</body>
</html>
